<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC Mini Trader</title>

  <style>
    :root { --bg:#0b1220; --card:#111a2c; --text:#e6eefc; --muted:#9bb0d0; }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    .wrap{ max-width:560px; margin:0 auto; }
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .title{ font-size:18px; margin:0 0 10px 0; }
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px; color: var(--muted);
      margin-left:8px;
      vertical-align: middle;
    }
    .hidden{ display:none !important; }

    .price{
      font-size:34px; font-weight:800; letter-spacing: .2px;
      margin: 6px 0 4px 0;
    }
    .sub{ color: var(--muted); margin:0 0 12px 0; font-size:13px; }

    .topGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
      margin-bottom:12px;
    }
    .stat{
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .stat .k{ color: var(--muted); font-size:12px; }
    .stat .v{ font-weight:800; font-size:16px; margin-top:4px; }

    .sliderBox{
      margin: 10px 0 14px 0;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .sliderRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }
    .sliderRow .label{ color: var(--muted); font-size:13px; }
    input[type="range"]{ width:100%; }

    .chartWrap{
      margin: 8px 0 14px 0;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    canvas{ display:block; width:100%; height:170px; }

    .row{ display:flex; gap:12px; }
    button{
      width:100%;
      padding:14px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      background: rgba(255,255,255,.06);
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }

    .pnlBox{
      margin-top:14px;
      padding:12px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }
    .pnlLabel{ color: var(--muted); font-size:13px; margin:0 0 6px 0; }
    .pnlValue{ font-size:20px; font-weight:900; margin:0; }
    .small{ color: var(--muted); font-size:12px; margin-top:10px; line-height:1.35; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">
        –ú–∏–Ω–∏-—Ç—Ä–µ–π–¥–µ—Ä BTC/USD
        <span id="posTag" class="tag hidden"></span>
        <span class="tag">Leverage x10</span>
      </h1>

      <div class="topGrid">
        <div class="stat">
          <div class="k">–ë–∞–ª–∞–Ω—Å (Equity)</div>
          <div class="v" id="equity">$1,000.00</div>
        </div>
        <div class="stat">
          <div class="k">–î–æ—Å—Ç—É–ø–Ω–æ</div>
          <div class="v" id="available">$1,000.00</div>
        </div>
        <div class="stat">
          <div class="k">–ú–∞—Ä–∂–∞ (–≤ –ø–æ–∑–∏—Ü–∏–∏)</div>
          <div class="v" id="margin">$0.00</div>
        </div>
        <div class="stat">
          <div class="k">–û–±—ä—ë–º (Notional)</div>
          <div class="v" id="notional">$0.00</div>
        </div>
      </div>

      <p class="price" id="price">$45,000.00</p>
      <p class="sub">–ö—É—Ä—Å –º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –Ω–∞ ¬±1% (—Å–ª—É—á–∞–π–Ω–æ). –ì—Ä–∞—Ñ–∏–∫: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–≤–µ—á–µ–π.</p>

      <div class="sliderBox" id="sliderBox">
        <div class="sliderRow">
          <div class="label">–í—Ö–æ–¥: <b id="pctLabel">10%</b> –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞</div>
          <div class="label">–ú–∞—Ä–∂–∞: <b id="marginPreview">$100.00</b></div>
        </div>
        <input id="pctSlider" type="range" min="1" max="100" value="10" />
        <div class="small">–ü–æ–¥ x10 –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–Ω–æ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—ã ~10% –ø—Ä–æ—Ç–∏–≤ —Ç–µ–±—è (–µ—Å–ª–∏ –≤—Å—è –º–∞—Ä–∂–∞ –≤ —Å–¥–µ–ª–∫–µ).</div>
      </div>

      <div class="chartWrap">
        <canvas id="chart"></canvas>
      </div>

      <div class="row" id="entryRow">
        <button id="longBtn">–õ–æ–Ω–≥</button>
        <button id="shortBtn">–®–æ—Ä—Ç</button>
      </div>

      <div class="row hidden" id="closeRow">
        <button id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="pnlBox hidden" id="pnlBox">
        <p class="pnlLabel">–¢–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
        <p class="pnlValue" id="pnlValue">0.00%</p>
        <div class="small" id="pnlDetails"></div>
      </div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const LEVERAGE = 10;
    const MAX_CANDLES = 10;

    // ======= STATE =======
    let price = 45000;

    // "–∫–æ—à–µ–ª—ë–∫"
    let equity = 1000;       // –æ–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª
    let available = 1000;    // –¥–æ—Å—Ç—É–ø–Ω–æ (equity - marginLocked)
    let marginLocked = 0;    // –º–∞—Ä–∂–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏

    // –ø–æ–∑–∏—Ü–∏—è
    let position = null;     // 'long' | 'short' | null
    let entryPrice = null;
    let margin = 0;
    let notional = 0;

    let lastPnlPct = 0;
    let lastPnlUsd = 0;

    // —Å–≤–µ—á–∏
    const candles = [];

    // ======= DOM =======
    const priceEl = document.getElementById('price');

    const equityEl = document.getElementById('equity');
    const availableEl = document.getElementById('available');
    const marginEl = document.getElementById('margin');
    const notionalEl = document.getElementById('notional');

    const pctSlider = document.getElementById('pctSlider');
    const pctLabel = document.getElementById('pctLabel');
    const marginPreview = document.getElementById('marginPreview');
    const sliderBox = document.getElementById('sliderBox');

    const longBtn = document.getElementById('longBtn');
    const shortBtn = document.getElementById('shortBtn');
    const closeBtn = document.getElementById('closeBtn');
    const entryRow = document.getElementById('entryRow');
    const closeRow = document.getElementById('closeRow');

    const pnlBox = document.getElementById('pnlBox');
    const pnlValue = document.getElementById('pnlValue');
    const pnlDetails = document.getElementById('pnlDetails');
    const posTag = document.getElementById('posTag');

    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');

    // ======= HELPERS =======
    function fmtMoney(x) {
      return x.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
    }
    function fmtPct(x) {
      const sign = x > 0 ? '+' : '';
      return `${sign}${x.toFixed(2)}%`;
    }
    function randomStepWithin1pct() {
      return (Math.random() * 2 - 1) * 0.01;
    }
    function randBetween(a, b) { return a + Math.random() * (b - a); }

    function resizeCanvasToDisplaySize() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.round(rect.width * dpr);
      const h = Math.round(rect.height * dpr);
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
    }

    // ======= FINANCE LOGIC =======
    function calcPnlUsd(curPrice) {
      if (!position || !entryPrice) return 0;
      if (position === 'long') return notional * (curPrice / entryPrice - 1);
      return notional * (entryPrice / curPrice - 1); // short
    }
    function calcPnlPctOnMargin(pnlUsd) {
      // PnL% –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–∞—Ä–∂–∏
      if (!margin) return 0;
      return (pnlUsd / margin) * 100;
    }

    function updateStatsUI() {
      equityEl.textContent = fmtMoney(equity);
      availableEl.textContent = fmtMoney(available);
      marginEl.textContent = fmtMoney(marginLocked);
      notionalEl.textContent = fmtMoney(position ? notional : 0);

      // preview –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞
      const pct = Number(pctSlider.value);
      pctLabel.textContent = pct + '%';
      const m = Math.max(0, available * (pct / 100));
      marginPreview.textContent = fmtMoney(m);
    }

    function renderPrice() {
      priceEl.textContent = fmtMoney(price);
    }

    function renderPnl() {
      const pnlUsd = calcPnlUsd(price);
      const pnlPct = calcPnlPctOnMargin(pnlUsd);

      lastPnlUsd = pnlUsd;
      lastPnlPct = pnlPct;

      pnlValue.textContent =
        (pnlUsd >= 0 ? 'üü¢ ' : 'üî¥ ') + `${fmtPct(pnlPct)}  (${pnlUsd >= 0 ? '+' : ''}${fmtMoney(pnlUsd)})`;

      pnlDetails.textContent =
        `–í—Ö–æ–¥: ${fmtMoney(entryPrice)} ‚Ä¢ –°–µ–π—á–∞—Å: ${fmtMoney(price)}\n` +
        `–ú–∞—Ä–∂–∞: ${fmtMoney(margin)} ‚Ä¢ –û–±—ä—ë–º: ${fmtMoney(notional)} ‚Ä¢ –ü–ª–µ—á–æ: x${LEVERAGE}`;

      // –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è: –ø–æ—Ç–µ—Ä—è–ª–∏ –≤—Å—é –º–∞—Ä–∂—É
      if (pnlUsd <= -margin) {
        liquidate();
      }
    }

    function resetUI() {
      position = null;
      entryPrice = null;
      margin = 0;
      notional = 0;
      lastPnlUsd = 0;
      lastPnlPct = 0;

      entryRow.classList.remove('hidden');
      closeRow.classList.add('hidden');
      pnlBox.classList.add('hidden');
      sliderBox.classList.remove('hidden');

      posTag.classList.add('hidden');
      posTag.textContent = '';

      updateStatsUI();
    }

    function openPosition(type) {
      if (position) return;
      if (available <= 0.01) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏.');
        return;
      }

      const pct = Number(pctSlider.value);
      const m = available * (pct / 100);

      if (m <= 0.01) {
        alert('–°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∞—è –º–∞—Ä–∂–∞. –£–≤–µ–ª–∏—á—å –ø—Ä–æ—Ü–µ–Ω—Ç –∏–ª–∏ –ø–æ–ø–æ–ª–Ω–∏ –±–∞–ª–∞–Ω—Å :)');
        return;
      }

      position = type;
      entryPrice = price;
      margin = m;
      notional = margin * LEVERAGE;

      // –±–ª–æ–∫–∏—Ä—É–µ–º –º–∞—Ä–∂—É
      marginLocked = margin;
      available = equity - marginLocked;

      // UI
      entryRow.classList.add('hidden');
      closeRow.classList.remove('hidden');
      pnlBox.classList.remove('hidden');
      sliderBox.classList.add('hidden');

      posTag.textContent = type.toUpperCase();
      posTag.classList.remove('hidden');

      updateStatsUI();
      renderPnl();
    }

    function closePosition(reason = 'close') {
      if (!position) return;

      // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∏—Ç–æ–≥
      const pnlUsd = Math.max(calcPnlUsd(price), -margin); // –Ω–µ –Ω–∏–∂–µ -–º–∞—Ä–∂–∏
      const pnlPct = calcPnlPctOnMargin(pnlUsd);

      // –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º–∞—Ä–∂—É –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º PnL
      // equity –¥–æ —Å–¥–µ–ª–∫–∏ –±—ã–ª–æ equity; –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ –º–µ–Ω—è–µ—Ç equity
      equity = equity + pnlUsd;

      // —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –º–∞—Ä–∂–∏
      marginLocked = 0;
      available = equity;

      const title = reason === 'liq' ? '–õ–∏–∫–≤–∏–¥–∞—Ü–∏—è' : '–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞';
      const text =
        `${title}\n` +
        `${position.toUpperCase()} ‚Ä¢ –í—Ö–æ–¥: ${fmtMoney(entryPrice)} ‚Üí –í—ã—Ö–æ–¥: ${fmtMoney(price)}\n` +
        `–ú–∞—Ä–∂–∞: ${fmtMoney(margin)} ‚Ä¢ –û–±—ä—ë–º: ${fmtMoney(notional)} (x${LEVERAGE})\n` +
        `–ò—Ç–æ–≥: ${fmtPct(pnlPct)}  (${pnlUsd >= 0 ? '+' : ''}${fmtMoney(pnlUsd)})\n` +
        `–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${fmtMoney(equity)}`;

      alert(text);
      resetUI();
    }

    function liquidate() {
      // —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–ª–æ—Å—å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
      if (!position) return;
      closePosition('liq');
    }

    // ======= CANDLES & CHART =======
    function pushCandle(open, close) {
      const baseHi = Math.max(open, close);
      const baseLo = Math.min(open, close);

      const wickUp = baseHi * randBetween(0, 0.003);
      const wickDn = baseLo * randBetween(0, 0.003);

      const high = baseHi + wickUp;
      const low = Math.max(1, baseLo - wickDn);

      candles.push({ o: open, h: high, l: low, c: close });
      while (candles.length > MAX_CANDLES) candles.shift();
    }

    function drawChart() {
      resizeCanvasToDisplaySize();
      const W = canvas.width, H = canvas.height;

      ctx.clearRect(0, 0, W, H);

      const dpr = window.devicePixelRatio || 1;
      const pad = Math.round(12 * dpr);
      const innerW = W - pad * 2;
      const innerH = H - pad * 2;

      if (candles.length === 0) return;

      let hi = -Infinity, lo = Infinity;
      for (const c of candles) { hi = Math.max(hi, c.h); lo = Math.min(lo, c.l); }
      const marginY = (hi - lo) * 0.08 || hi * 0.01;
      hi += marginY; lo -= marginY;

      function yOf(val) {
        const t = (val - lo) / (hi - lo);
        return pad + (innerH * (1 - t));
      }

      // grid
      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = 'rgba(255,255,255,0.20)';
      ctx.lineWidth = 1;
      for (let i = 1; i <= 3; i++) {
        const y = pad + innerH * (i / 4);
        ctx.beginPath();
        ctx.moveTo(pad, y);
        ctx.lineTo(pad + innerW, y);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;

      const n = candles.length;
      const slot = innerW / n;
      const bodyW = Math.max(3 * dpr, slot * 0.55);

      for (let i = 0; i < n; i++) {
        const c = candles[i];
        const xCenter = pad + slot * (i + 0.5);

        const yOpen = yOf(c.o);
        const yClose = yOf(c.c);
        const yHigh = yOf(c.h);
        const yLow  = yOf(c.l);

        const isGreen = c.c >= c.o;

        ctx.strokeStyle = isGreen ? 'rgba(0,255,140,0.85)' : 'rgba(255,70,70,0.85)';
        ctx.lineWidth = Math.max(1 * dpr, bodyW * 0.12);
        ctx.beginPath();
        ctx.moveTo(xCenter, yHigh);
        ctx.lineTo(xCenter, yLow);
        ctx.stroke();

        const top = Math.min(yOpen, yClose);
        const bottom = Math.max(yOpen, yClose);
        const bodyH = Math.max(2 * dpr, bottom - top);

        ctx.fillStyle = isGreen ? 'rgba(0,255,140,0.85)' : 'rgba(255,70,70,0.85)';
        ctx.fillRect(xCenter - bodyW / 2, top, bodyW, bodyH);
      }
    }

    function seedCandles() {
      let p = price;
      for (let i = 0; i < MAX_CANDLES; i++) {
        const step = randomStepWithin1pct();
        const next = Math.max(p * (1 + step), 1);
        pushCandle(p, next);
        p = next;
      }
      price = p;
      renderPrice();
    }

    // ======= EVENTS =======
    longBtn.addEventListener('click', () => openPosition('long'));
    shortBtn.addEventListener('click', () => openPosition('short'));
    closeBtn.addEventListener('click', () => closePosition('close'));

    pctSlider.addEventListener('input', updateStatsUI);
    window.addEventListener('resize', drawChart);

    // ======= LOOP =======
    function tick() {
      const open = price;
      const close = Math.max(open * (1 + randomStepWithin1pct()), 1);

      price = close;

      pushCandle(open, close);
      renderPrice();
      drawChart();

      if (position) {
        renderPnl();
      }
    }

    // —Å—Ç–∞—Ä—Ç
    seedCandles();
    updateStatsUI();
    drawChart();
    setInterval(tick, 1000);
  </script>
</body>
</html>
