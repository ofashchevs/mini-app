<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC Mini Trader</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { --bg:#0b1220; --card:#111a2c; --text:#e6eefc; --muted:#9bb0d0; }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    .wrap{ max-width:520px; margin:0 auto; }
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .title{ font-size:18px; margin:0 0 10px 0; }
    .price{
      font-size:34px; font-weight:800; letter-spacing: .2px;
      margin: 0 0 4px 0;
    }
    .sub{ color: var(--muted); margin:0 0 16px 0; font-size:13px; }
    .row{ display:flex; gap:12px; }
    button{
      width:100%;
      padding:14px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      background: rgba(255,255,255,.06);
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition: transform .05s ease;
      user-select:none;
    }
    button:active{ transform: scale(.99); }
    .hidden{ display:none !important; }

    .pnlBox{
      margin-top:14px;
      padding:12px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }
    .pnlLabel{ color: var(--muted); font-size:13px; margin:0 0 6px 0; }
    .pnlValue{ font-size:22px; font-weight:800; margin:0; }
    .small{ color: var(--muted); font-size:12px; margin-top:10px; }
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px; color: var(--muted);
      margin-left:8px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">–ú–∏–Ω–∏-—Ç—Ä–µ–π–¥–µ—Ä BTC/USD <span id="posTag" class="tag hidden"></span></h1>

      <p class="price" id="price">$0.00</p>
      <p class="sub" id="hint">–ö—É—Ä—Å –º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –Ω–∞ ¬±1% (—Å–ª—É—á–∞–π–Ω–æ).</p>

      <div class="row" id="entryRow">
        <button id="longBtn">–õ–æ–Ω–≥</button>
        <button id="shortBtn">–®–æ—Ä—Ç</button>
      </div>

      <div class="row hidden" id="closeRow" style="position: relative; z-index: 10;">
        <button id="closeBtn" style="pointer-events: auto;">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="pnlBox hidden" id="pnlBox">
        <p class="pnlLabel">–¢–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (PnL)</p>
        <p class="pnlValue" id="pnlValue">0.00%</p>
        <div class="small" id="pnlDetails"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Telegram init (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –∫—Ä–∞—Å–∏–≤–æ –¥–ª—è Mini App)
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      // tg.setHeaderColor('#0b1220'); // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
      // tg.setBackgroundColor('#0b1220'); // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    }

    // --- State
    let price = 45000;              // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ (–ª—é–±–∞—è)
    let intervalId = null;

    let position = null;            // null | 'long' | 'short'
    let entryPrice = null;
    let lastPnl = 0;

    // --- DOM
    const priceEl = document.getElementById('price');
    const longBtn = document.getElementById('longBtn');
    const shortBtn = document.getElementById('shortBtn');
    const closeBtn = document.getElementById('closeBtn');

    const entryRow = document.getElementById('entryRow');
    const closeRow = document.getElementById('closeRow');
    const pnlBox = document.getElementById('pnlBox');
    const pnlValue = document.getElementById('pnlValue');
    const pnlDetails = document.getElementById('pnlDetails');
    const posTag = document.getElementById('posTag');

    // --- Helpers
    function fmtMoney(x) {
      return x.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
    }
    function fmtPct(x) {
      const sign = x > 0 ? '+' : '';
      return `${sign}${x.toFixed(2)}%`;
    }

    function randomStepWithin1pct() {
      // —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç -0.01 –¥–æ +0.01
      return (Math.random() * 2 - 1) * 0.01;
    }

    function calcPnlPercent() {
      if (!position || !entryPrice) return 0;
      if (position === 'long') {
        return (price / entryPrice - 1) * 100;
      } else {
        // short: –ø—Ä–∏–±—ã–ª—å, –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç
        return (entryPrice / price - 1) * 100;
      }
    }

    function renderPrice() {
      priceEl.textContent = fmtMoney(price);
    }

    function renderPnl() {
      if (!position) return;
      lastPnl = calcPnlPercent();

      pnlValue.textContent = fmtPct(lastPnl);
      pnlDetails.textContent = `–í—Ö–æ–¥: ${fmtMoney(entryPrice)} ‚Ä¢ –°–µ–π—á–∞—Å: ${fmtMoney(price)}`;

      // –ø—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–±–µ–∑ —Ü–≤–µ—Ç–æ–≤ –º–æ–∂–Ω–æ, –Ω–æ –¥–æ–±–∞–≤–∏–º —á–µ—Ä–µ–∑ emoji)
      pnlValue.textContent = (lastPnl >= 0 ? 'üü¢ ' : 'üî¥ ') + fmtPct(lastPnl);
    }

    function resetUI() {
      position = null;
      entryPrice = null;
      lastPnl = 0;

      entryRow.classList.remove('hidden');
      closeRow.classList.add('hidden');

      pnlBox.classList.add('hidden');
      posTag.classList.add('hidden');
      posTag.textContent = '';

      // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–∏ —Å–ø—Ä—è—Ç–∞–Ω—ã)
      longBtn.classList.remove('hidden');
      shortBtn.classList.remove('hidden');
    }

    function showTelegramNotice(text) {
      if (tg?.showPopup) {
        tg.showPopup({
          title: '–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞',
          message: text,
          buttons: [{ type: 'ok' }]
        });
      } else if (tg?.showAlert) {
        tg.showAlert(text);
      } else {
        alert(text);
      }
    }

    // --- Trading actions
    function openPosition(type) {
      if (position) return; // —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞

      position = type;
      entryPrice = price;

      // UI: —Å–∫—Ä—ã—Ç—å –≤—Ç–æ—Ä—É—é –∫–Ω–æ–ø–∫—É, –∑–∞–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–∞ Close (–º—ã –¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π closeRow)
      entryRow.classList.add('hidden');
      closeRow.classList.remove('hidden');

      pnlBox.classList.remove('hidden');

      posTag.textContent = type === 'long' ? 'LONG' : 'SHORT';
      posTag.classList.remove('hidden');

      renderPnl();
    }

    function closePosition() {
      if (!position) return;
      renderPnl(); // —á—Ç–æ–±—ã –≤–∑—è—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π pnl –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–∏—è

      const text = `${position.toUpperCase()} ‚Ä¢ –í—Ö–æ–¥: ${fmtMoney(entryPrice)} ‚Üí –í—ã—Ö–æ–¥: ${fmtMoney(price)}\n–ò—Ç–æ–≥: ${fmtPct(lastPnl)}`;
      showTelegramNotice(text);

      resetUI();
    }

    // --- Events
    longBtn.addEventListener('click', () => openPosition('long'));
    shortBtn.addEventListener('click', () => openPosition('short'));
    closeBtn.addEventListener('click', closePosition);

    // --- Price loop (–∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
    function tick() {
      const step = randomStepWithin1pct();
      price = price * (1 + step);
      // –º–∞–ª–µ–Ω—å–∫–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ/–Ω—É–ª–µ–≤–æ–≥–æ
      price = Math.max(price, 1);

      renderPrice();
      if (position) renderPnl();
    }

    // —Å—Ç–∞—Ä—Ç
    renderPrice();
    intervalId = setInterval(tick, 1000);
  </script>
</body>
</html>
